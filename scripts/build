#!/bin/bash
set -ex

cd $(dirname $0)/..

. ./scripts/version

mkdir -p bin

if [ "$CROSS" = 1 ]; then
    CGO_ENABLED=0 GOOS=darwin go build -ldflags "-X main.VERSION=$VERSION"  -o ./bin/kustomize-Darwin-x86_64 ./kustomize/
    CGO_ENABLED=0 GOOS=windows go build -ldflags "-X main.VERSION=$VERSION" -o ./bin/kustomize-Windows-x86_64.exe ./kustomize/
    CGO_ENABLED=0 GOARCH=arm64 go build -a -tags netgo -installsuffix netgo -ldflags "-X main.VERSION=$VERSION" -o ./bin/kustomize-Linux-arm64 ./kustomize/
    CGO_ENABLED=0 GOARCH=ppc64le go build -a -tags netgo -installsuffix netgo -ldflags "-X main.VERSION=$VERSION" -o ./bin/kustomize-Linux-ppc64le ./kustomize/
    CGO_ENABLED=0 GOARCH=arm GOARM=6 go build -a -tags netgo -installsuffix netgo -ldflags "-X main.VERSION=$VERSION" -o ./bin/kustomize-Linux-arm ./kustomize/
    CGO_ENABLED=0 GOARCH=arm GOARM=6 go build -a -tags netgo -installsuffix netgo -ldflags "-X main.VERSION=$VERSION" -o ./bin/kustomize-Linux-armv6l ./kustomize/
    CGO_ENABLED=0 GOARCH=arm GOARM=7 go build -a -tags netgo -installsuffix netgo -ldflags "-X main.VERSION=$VERSION" -o ./bin/kustomize-Linux-armv7l .kustomize/
    CGO_ENABLED=0 GOARCH=amd64 go build -a -tags netgo -installsuffix netgo -ldflags "-X main.VERSION=$VERSION -extldflags '-static -s'" -o ./bin/kustomize-Linux-x86_64 ./kustomize/
    cp ./bin/kustomize-Linux-arm64 ./bin/kustomize-Linux-aarch64

    cp ./bin/kustomize-$(uname -s)-$(uname -m) ./bin/kustomizebuild
    echo Built ./bin/kustomize-$(uname -s)-$(uname -m)
else
    CGO_ENABLED=0 go build -a -tags netgo -installsuffix netgo -ldflags "-X main.VERSION=$VERSION -extldflags '-static -s'" -o ./bin/kustomizebuild ./kustomize/
    echo Built ./bin/kustomizebuild
fi
